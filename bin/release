#!/bin/bash

# Script to version, tag, and release a new version of the package.

set -e

ROOT=$(npm prefix)

function cleanup {
  echo
  git tag -d $(git log -1 --pretty=%B)  # Delete the last tag
  git reset --hard HEAD^
  exit 1
}

# Update the list of contributors.
json -I -f ${ROOT}/ohm-js/package.json -e "this.contributors=[$(${ROOT}/bin/get-contributors)]"

if [ "$(git status --porcelain | grep -v '??')" != "" ]; then
  echo "Error: git working directory not clean -- run 'git status' for more info."
  exit 1
fi

yarn workspace ohm-js publish
git push && git push --tags

$(dirname $0)/deploy-gh-pages.sh
